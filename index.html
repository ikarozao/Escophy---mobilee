<!DOCTYPE html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login - Escorphy</title>
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" type="image/png" href="img/a.png" />
</head>

<body>

  <div class="background-carousel">
    <img class="bg-img active" src="img/inicio1.jpg" alt="Imagem 1" />
    <img class="bg-img" src="img/inicio2.jpg" alt="Imagem 2" />
    <img class="bg-img" src="img/inicio3.jpg" alt="Imagem 3" />
    <img class="bg-img" src="img/inicio4.jpg" alt="Imagem 4" />
  </div>

  <main class="container">
    <!-- Formulário de Login -->
    <form id="login-form" class="form active">
      <h1>Login</h1>
      <div class="input-box">
        <input id="email-login" placeholder="Email" type="email" required />
        <i class="bx bx-user"></i>
      </div>
      <div class="input-box">
        <input id="senha-login" placeholder="Senha" type="password" required />
        <i class="bx bx-show toggle-password" data-target="senha-login"></i>
      </div>

      <button class="login" type="submit">Login</button>

      <div class="register-link">
        <p>Não tem uma conta? <a href="#" id="show-register">Cadastre-se</a></p>
      </div>
    </form>

    <!-- Formulário de Cadastro -->
    <form id="register-form" class="form">
      <h1>Cadastro</h1>
      <div class="input-box">
        <input id="nome-cadastro" placeholder="Nome" type="text" required />
        <i class="bx bx-user"></i>
      </div>
      <div class="input-box">
        <input id="email-cadastro" placeholder="Email" type="email" required />
        <i class="bx bx-envelope"></i>
      </div>
      <div class="input-box">
        <input id="senha-cadastro" placeholder="Senha" type="password" required />
        <i class="bx bx-show toggle-password" data-target="senha-cadastro"></i>
      </div>

      <button class="login" type="submit">Cadastrar</button>

      <div class="register-link">
        <p>Já tem uma conta? <a href="#" id="show-login">Login</a></p>
      </div>
    </form>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>

  <script>
    // =========================
    // Carrossel
    // =========================
    const images = document.querySelectorAll('.bg-img');
    let current = 0;

    setInterval(() => {
      images[current].classList.remove('active');
      current = (current + 1) % images.length;
      images[current].classList.add('active');
    }, 6000);

    // =========================
    // Alternar forms
    // =========================
    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const showRegister = document.getElementById('show-register');
    const showLogin = document.getElementById('show-login');

    showRegister?.addEventListener('click', (e) => {
      e.preventDefault();
      loginForm.classList.remove('active');
      registerForm.classList.add('active');
    });

    showLogin?.addEventListener('click', (e) => {
      e.preventDefault();
      registerForm.classList.remove('active');
      loginForm.classList.add('active');
    });

    // =========================
    // Supabase Config
    // =========================
    const SUPABASE_URL = 'https://szachxclixfketavlkyv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6YWNoeGNsaXhma2V0YXZsa3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDYwNTIsImV4cCI6MjA2OTg4MjA1Mn0.mL71dNsCRvhVluuiz6WUB9fBeLZoy6QyMue6nc3B_-g';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =========================
    // LOGIN (apenas tabela usuarios)
    // =========================
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const email = document.getElementById('email-login').value;
      const senha = document.getElementById('senha-login').value;

      try {
        console.log("🔐 Tentando login...");

        // Busca usuário na tabela usuarios
        const { data: usuarios, error } = await supabaseClient
          .from('usuarios')
          .select('*')
          .eq('email', email)
          .eq('senha', senha)
          .single();

        if (error || !usuarios) {
          console.error('❌ Erro no login:', error);
          alert('Email ou senha incorretos!');
          return;
        }

        console.log('✅ Login OK:', usuarios);

        // Salva no localStorage
        localStorage.setItem("usuarioLogado", usuarios.nome);
        localStorage.setItem("usuarioEmail", usuarios.email);
        localStorage.setItem("usuarioId", usuarios.id);

        // Redireciona para home
        window.location.href = "home.html";

      } catch (err) {
        console.error('❌ Erro no login:', err);
        alert('Erro ao fazer login!');
      }
    });

    // =========================
    // CADASTRO (apenas tabela usuarios)
    // =========================
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      const nome = document.getElementById('nome-cadastro').value;
      const email = document.getElementById('email-cadastro').value;
      const senha = document.getElementById('senha-cadastro').value;

      try {
        console.log("📝 Tentando cadastro...");

        // Primeiro verifica se o email já existe
        const { data: usuarioExistente, error: checkError } = await supabaseClient
          .from('usuarios')
          .select('email')
          .eq('email', email)
          .single();

        if (usuarioExistente) {
          alert('❌ Este email já está cadastrado!');
          return;
        }

        // Insere na tabela usuarios
        const { data, error } = await supabaseClient
          .from('usuarios')
          .insert([
            {
              nome: nome,
              email: email,
              senha: senha,
              created_at: new Date().toISOString()
            }
          ])
          .select();

        if (error) {
          console.error("❌ Erro no cadastro:", error);
          alert("Erro no cadastro: " + error.message);
          return;
        }

        console.log("✅ Cadastro realizado:", data);

        // Salva no localStorage
        localStorage.setItem("usuarioLogado", nome);
        localStorage.setItem("usuarioEmail", email);
        localStorage.setItem("usuarioId", data[0].id);

        alert("✅ Cadastro realizado com sucesso!");
        
        // Redireciona para home
        window.location.href = "home.html";

      } catch (err) {
        console.error("❌ Erro no cadastro:", err);
        alert("Erro ao cadastrar!");
      }
    });

    // =========================
    // Verificar se usuário já está logado
    // =========================
    function checkLogin() {
      const usuarioEmail = localStorage.getItem("usuarioEmail");
      if (usuarioEmail) {
        // Usuário já logado, redireciona para home
        window.location.href = "home.html";
      }
    }

    checkLogin();

    // =========================
    // Toggle Password Visibility
    // =========================
    document.querySelectorAll(".toggle-password").forEach((icon) => {
      icon.addEventListener("click", () => {
        const inputId = icon.getAttribute("data-target");
        const input = document.getElementById(inputId);

        if (input.type === "password") {
          input.type = "text";
          icon.classList.remove("bx-show");
          icon.classList.add("bx-hide");
        } else {
          input.type = "password";
          icon.classList.remove("bx-hide");
          icon.classList.add("bx-show");
        }
      });
    });

  </script>
</body>
</html>