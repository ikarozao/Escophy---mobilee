<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="perfil/perfil.css">
    <link rel="icon" type="image/png" href="img/a.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
    <nav>
        <a href="home.html"><div class="bar_n">Escorphy</div></a>
        <div class="nav-right">
            <div class="search-box">
                <input type="text" placeholder="Pesquisar..." />
            </div>
        </div>
    </nav>

    <div class="main-content-perfil">
        <div class="column left-column">
            <article class="usuario">
                <div>
                    <h2 id="nomeUsuario">Olá, usuario</h2>
                </div>

                <div class="foto_perfil" id="fotoPerfil">
                    <img id="imgPerfil" src="img/perfil-removebg-preview.png" alt="Imagem do perfil">
                </div>

                <input type="file" id="inputPerfil" accept="image/*" hidden>

                <article class="info_usua">
                    <span>Treinos</span>
                    <span>Publicações</span>
                    <span>Seguidores</span>
                    <span>Seguindo</span>
                </article>

                <article class="info_usua2">
                    <span id="contTreinos">0</span>
                    <span id="contPublicacoes">0</span>
                    <span>50</span>
                    <span>20</span>
                </article>
            </article>

            <!-- Treinos Realizados -->
            <article class="treinos">
                <div>
                    <h2>Treinos Realizados</h2>
                </div>
                <div>
                    <ul id="listaTreinos"></ul>
                </div>
            </article>

            <section class="feed">
            <h2>Vídeos sugeridos</h2>

            <article class="post">
                <div class="youtube-video-container">
                <iframe src="https://www.youtube.com/embed/LsvhNS4w8zc" allowfullscreen></iframe>
            </div>
            </article>

            <article class="post">
                <div class="youtube-video-container">
                <iframe src="https://www.youtube.com/embed/0JDIeCiexgI" allowfullscreen></iframe>
            </div>
            </article>

            <article class="post">
                <div class="youtube-video-container">
                <iframe src="https://www.youtube.com/embed/MiCmcdcF_Ss" allowfullscreen></iframe>
            </div>
            </article>

            <article class="post">
                <div class="youtube-video-container">
                <iframe src="https://www.youtube.com/embed/Nys6iOhtjp0" allowfullscreen></iframe>
            </div>
            </article>
        </section>

        </div>

        <div class="column right-column">
            <!-- Publicações do usuário -->
            <article class="publi_usua">
                <div>
                    <h2>Galeria</h2>
                </div>
                <div id="listaPublicacoes"></div>
            </article>

            <!-- Contas Sugeridas 
            <article class="sugeridos">
                <div>
                    <h2>Contas Sugeridas</h2>
                </div>
                <article class="contas_sugeridas">
                    <div class="cs2">
                        <div class="foto_perfil">
                            <img src="img/perfil-removebg-preview.png" alt="Imagem do treino">
                        </div>
                        <div class="foto_upload">
                            <label for="upload" class="upload-btn-sugerido">@valeria</label>
                        </div>
                    </div>
                    <div class="cs2">
                        <div class="foto_perfil">
                            <img src="img/perfil-removebg-preview.png" alt="Imagem do treino">
                        </div>
                        <div class="foto_upload">
                            <label for="upload" class="upload-btn-sugerido">@almeida</label>
                        </div>
                    </div>
                    <div class="cs2">
                        <div class="foto_perfil">
                            <img src="img/perfil-removebg-preview.png" alt="Imagem do treino">
                        </div>
                        <div class="foto_upload">
                            <label for="upload" class="upload-btn-sugerido">@spatona</label>
                        </div>
                    </div>
                    <div class="cs2">
                        <div class="foto_perfil">
                            <img src="img/perfil-removebg-preview.png" alt="Imagem do treino">
                        </div>
                        <div class="foto_upload">
                            <label for="upload" class="upload-btn-sugerido">@itsme</label>
                        </div>
                    </div>
                </article>
            </article>-->
        </div>
    </div>

    <div class="floating-buttons-container">
        <a href="home.html">
            <div class="botaoperfil-container">
                <button class="botaoperfil" id="botaoperfil">
                    <img src="img/home.png" alt="Ícone Perfil">
                </button>
            </div>
        </a>
        <a href="treino1.html">
            <div class="botaomais-container">
                <button class="botaomais" id="botaoMais">+</button>
            </div>
        </a>
    </div>

    <footer class="footer">
    <div class="footer-container">
        <div class="footer-logo">
            <h1>ESCORPHY</h1>
            <p>© 2025 Escorphy</p>
        </div>

        <div class="footer-column">
            <h3>Sobre</h3>
            <ul>
                <li><a href="sobrenos.html">Nossa História</a></li>
                <li><a href="sobrenos.html">Missão</a></li>
                <li><a href="sobrenos.html">Equipe</a></li>
                <li><a href="#">Privacidade</a></li>
            </ul>
        </div>

        <div class="footer-column">
            <h3>Explorar</h3>
            <ul>
                <li><a href="#">Funcionalidades</a></li>
                <li><a href="#">Planos</a></li>
                <li><a href="#">Blog</a></li>
            </ul>
        </div>

        <div class="footer-column">
            <h3>Redes</h3>
            <ul class="social-icons">
                <li><a href="https://www.instagram.com/escorphybr"><i class="fab fa-instagram"></i> Instagram</a></li>
                <li><a href="https://www.youtube.com/escorphy"><i class="fab fa-youtube"></i> YouTube</a></li>
            </ul>
        </div>

        <div class="footer-column">
            <h3>Ajuda</h3>
            <ul>
                <li><a href="#">Suporte</a></li>
                <li><a href="https://mail.google.com/mail/u/0/#inbox?compose=CllgCJNxPFlgRKMfNbXtjRlNsMrbsQVVFLbfkqPmwWGZnCVDDPjSWwvcTngxGFMGsRTMztTSRxV">Fale Conosco</a></li>
                <li><a href="#">Central de Ajuda</a></li>
            </ul>
        </div>
    </div>
</footer>

    <script src="https://unpkg.com/@supabase/supabase-js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ===============================
        // Variáveis do usuário
        // ===============================
        const usuario = localStorage.getItem("usuarioLogado");
        const usuarioEmail = localStorage.getItem("usuarioEmail");

        console.log(usuario, usuarioEmail);

        // ===============================
        // Supabase
        // ===============================
        const supabaseUrl = 'https://szachxclixfketavlkyv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InN6YWNoeGNsaXhma2V0YXZsa3l2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzMDYwNTIsImV4cCI6MjA2OTg4MjA1Mn0.mL71dNsCRvhVluuiz6WUB9fBeLZoy6QyMue6nc3B_-g';
        const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

        const inputPerfil = document.getElementById("inputPerfil");
        const imgPerfil = document.getElementById("imgPerfil");
        const fotoPerfil = document.getElementById("fotoPerfil");

        // ===============================
        // Nome do usuário
        // ===============================
        if (usuario && usuario.trim() !== "") {
            document.getElementById("nomeUsuario").textContent = `Olá, ${usuario.trim()}`;
        }

        // ===============================
        // Clique na foto abre input
        // ===============================
        fotoPerfil.addEventListener("click", () => inputPerfil.click());

        // ===============================
        // Carregar foto do perfil
        // ===============================
        async function carregarFotoPerfil() {
            if (!usuarioEmail) return;

            const { data, error } = await supabaseClient
                .from("usuarios")
                .select("foto_perfil")
                .eq("email", usuarioEmail)
                .single();

            if (error) {
                console.error("Erro ao buscar foto de perfil:", error.message);
                return;
            }

            if (data?.foto_perfil) imgPerfil.src = data.foto_perfil;
        }

        // ===============================
        // Upload de nova foto
        // ===============================
        inputPerfil.addEventListener("change", async (event) => {
            const file = event.target.files[0];
            if (!file || !usuarioEmail) return;

            const fileName = `${usuarioEmail}_${Date.now()}_${file.name}`;
            try {
                await supabaseClient.storage.from("perfil").upload(fileName, file, { upsert: true });

                const { data: publicUrlData } = supabaseClient.storage.from("perfil").getPublicUrl(fileName);
                const publicUrl = publicUrlData.publicUrl;

                await supabaseClient.from("usuarios").update({ foto_perfil: publicUrl }).eq("email", usuarioEmail);
                imgPerfil.src = publicUrl;

            } catch (err) {
                console.error("Erro no upload de perfil:", err.message);
            }
        });

        // ===============================
        // Funções auxiliares para cálculos
        // ===============================
        function calcularDistanciaTotal(positions) {
            if (!positions || positions.length < 2) return 0;
            
            let totalDistance = 0;
            for (let i = 1; i < positions.length; i++) {
                const prev = positions[i - 1];
                const curr = positions[i];
                totalDistance += calcularDistancia(prev.lat, prev.lng, curr.lat, curr.lng);
            }
            return Math.round(totalDistance);
        }

        function calcularDistancia(lat1, lon1, lat2, lon2) {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calcularTempoTreino(startTime, endTime) {
            if (!startTime || !endTime) return "0min";
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            const minutes = Math.floor(diffMs / 60000);
            const hours = Math.floor(minutes / 60);
            const remainingMinutes = minutes % 60;
            
            if (hours > 0) {
                return `${hours}h ${remainingMinutes}min`;
            }
            return `${minutes}min`;
        }

        function calcularCalorias(distancia, intensidade) {
            // Fórmula simplificada: ~65 calorias por km para corrida
            const distanciaKm = distancia / 1000;
            const caloriasBase = distanciaKm * 65;
            const fatorIntensidade = 1 + (intensidade - 5) * 0.1;
            return Math.round(caloriasBase * fatorIntensidade);
        }

        // ===============================
        // Carregar treinos e publicações
        // ===============================
        async function carregarTreinosEPub() {
            if (!usuarioEmail) return;

            // Treinos realizados
            const { data: treinos, error: treinosError } = await supabaseClient
                .from("atividades")
                .select("*")
                .eq("email_usuario", usuarioEmail)
                .order("data", { ascending: false });

            if (treinosError) {
                console.error("Erro ao buscar treinos:", treinosError.message);
                return;
            }

            const listaTreinos = document.getElementById("listaTreinos");
            listaTreinos.innerHTML = "";

            treinos.forEach(t => {
                const li = document.createElement("li");
                const link = document.createElement("a");
                link.href = `treino1.html?id=${t.id}`;
                link.innerHTML = `
                    <span class="atividade">${t.titulo}</span> 
                    <span class="data">${new Date(t.data).toLocaleDateString('pt-BR')}</span>
                `;
                li.appendChild(link);
                listaTreinos.appendChild(li);
            });
            document.getElementById("contTreinos").textContent = treinos.length;

            // Publicações públicas
            const { data: publicacoes, error: pubsError } = await supabaseClient
                .from("atividades")
                .select("*")
                .eq("email_usuario", usuarioEmail)
                .eq("visibilidade", "Público")
                .order("data", { ascending: false });

            if (pubsError) {
                console.error("Erro ao buscar publicações:", pubsError.message);
                return;
            }

            const listaPublicacoes = document.getElementById("listaPublicacoes");
            listaPublicacoes.innerHTML = "";

            publicacoes.forEach(p => {
                const trajeto = p.trajeto || {};
                const positions = trajeto.positions || [];
                const distancia = trajeto.summary?.distance || calcularDistanciaTotal(positions);
                const tempo = calcularTempoTreino(
                    trajeto.summary?.startTime, 
                    trajeto.summary?.endTime || p.data
                );
                const calorias = calcularCalorias(distancia, p.intensidade);

                const div = document.createElement("div");
                div.className = "post";
                div.innerHTML = `
                    <a href="treino1.html?id=${p.id}" class="post-link">
                        <div class="post-header">
                            <h3 class="post-titulo">${p.titulo}</h3>
                            <span class="post-data">${new Date(p.data).toLocaleDateString('pt-BR')}</span>
                        </div>
                        <div class="detalhes">
                            <span>${getEmojiTipo(p.tipo)} ${p.tipo || 'Treino'}</span>
                            <span>📏 ${(distancia / 1000).toFixed(2)} km</span>
                            <span>⏱️ ${tempo}</span>
                            <span>🔥 ${calorias} kcal</span>
                            <span>💪 Intensidade: ${p.intensidade}/10</span>
                            ${p.acessorios ? `<span>🎧 ${p.acessorios}</span>` : ''}
                        </div>
                        ${positions.length > 0 ? `
                            <div class="mapa-miniatura" id="mapa-${p.id}"></div>
                        ` : ''}
                        <div class="post-stats">
                            <div class="stat">
                                <span class="stat-valor">${(distancia / 1000).toFixed(1)}</span>
                                <span class="stat-label">km</span>
                            </div>
                            <div class="stat">
                                <span class="stat-valor">${tempo.split(' ')[0]}</span>
                                <span class="stat-label">${tempo.includes('h') ? 'tempo' : 'min'}</span>
                            </div>
                            <div class="stat">
                                <span class="stat-valor">${calorias}</span>
                                <span class="stat-label">cal</span>
                            </div>
                            <div class="stat">
                                <span class="stat-valor">${p.intensidade}</span>
                                <span class="stat-label">intens</span>
                            </div>
                        </div>
                    </a>
                `;
                listaPublicacoes.appendChild(div);

                // Carrega mapa miniaturas se houver trajeto
                if (positions.length > 0) {
                    setTimeout(() => {
                        carregarMapaMiniatura(p.id, positions);
                    }, 100);
                }
            });

            document.getElementById("contPublicacoes").textContent = publicacoes.length;
        }

        function getEmojiTipo(tipo) {
            const emojis = {
                'Corrida': '🏃',
                'Ciclismo': '🚴',
                'Musculação': '💪',
                'Yoga': '🧘',
                'Caminhada': '🚶',
                'Natação': '🏊',
                'Treino': '🏅',
                'Prova': '🥇',
                'Longão': '🛣️'
            };
            return emojis[tipo] || '🏅';
        }

        function carregarMapaMiniatura(postId, positions) {
            const container = document.getElementById(`mapa-${postId}`);
            if (!container) return;

            // Limpa o container
            container.innerHTML = '';
            
            // Cria mapa
            const map = L.map(container, {
                zoomControl: false,
                attributionControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false
            });

            // Tile layer simplificado
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 18
            }).addTo(map);

            // Adiciona polyline do trajeto
            if (positions.length > 0) {
                const latLngs = positions.map(pos => [pos.lat, pos.lng]);
                const polyline = L.polyline(latLngs, {
                    color: '#e34c26',
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);

                // Ajusta o zoom para o trajeto
                map.fitBounds(polyline.getBounds(), {
                    padding: [5, 5]
                });
            }
        }

        // ===============================
        // Inicializar
        // ===============================
        carregarFotoPerfil();
        carregarTreinosEPub();
    </script>
</body>
</html>